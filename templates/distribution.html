{% extends "base.html" %}

{% block title %}Приемка терминала{% endblock title %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="distribution-container">
    <!-- Заголовок и кнопка -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    <path d="M9 14h6"></path>
                    <path d="M9 10h6"></path>
                    <path d="M12 18h.01"></path>
                </svg>
            </div>
            <h1 class="page-title">Распределение терминалов</h1>
        </div>
        <button type="button" class="btn-assign" data-bs-toggle="modal" data-bs-target="#assignCityModal">
            <span class="btn-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
            </span>
            <span class="btn-text">Назначить город коробкам</span>
        </button>
    </div>

    <!-- Карточка с таблицей -->
    <div class="data-card">
        <div class="card-header-custom">
            <div class="header-content">
                <div class="header-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                </div>
                <h5 class="card-title">Список терминалов</h5>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <label for="searchInput"></label><input type="text" id="searchInput" placeholder="Поиск..." class="search-input">
                    <div class="search-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="brand">
                            <div class="th-content">
                                Бренд
                                <span class="sort-icon">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </th>
                        <th class="sortable" data-sort="model">
                            <div class="th-content">
                                Модель
                                <span class="sort-icon">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </th>
                        <th class="sortable" data-sort="box">
                            <div class="th-content">
                                Коробка
                                <span class="sort-icon">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </th>
                        <th class="sortable" data-sort="quantity">
                            <div class="th-content">
                                Количество
                                <span class="sort-icon">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in serials %}
                    <tr>
                        <td class="brand-cell">{{ item.brand }}</td>
                        <td class="model-cell">{{ item.model }}</td>
                        <td class="box-cell">
                            <span class="box-badge">{{ item.box }}</span>
                        </td>
                        <td class="quantity-cell">
                            <span class="quantity-badge">{{ item.total }}</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="empty-row">
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="3" y1="9" x2="21" y2="9"></line>
                                        <line x1="9" y1="21" x2="9" y2="9"></line>
                                    </svg>
                                </div>
                                <p class="empty-text">Нет данных для отображения</p>
                                <button class="btn-add-data">Добавить данные</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="card-footer">
            <div class="pagination-info" style="margin-left: 10px">
                <span>Показано <strong>{{ serials|length }}</strong> записей</span>
            </div>
            <div class="pagination-controls" style="margin-right: 15px; padding-top: 5px; padding-bottom: 5px">
                <button class="pagination-btn" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <span class="pagination-current">1</span>
                <button class="pagination-btn" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Улучшенное модальное окно -->
<div class="modal fade" id="assignCityModal" tabindex="-1" aria-labelledby="assignCityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="post" action="{% url 'distribution' %}" class="modal-form">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header-content">
                        <div class="modal-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </div>
                        <h5 class="modal-title" id="assignCityModalLabel">Назначить город коробкам</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Счетчик выбранных коробок -->
                    <div class="selection-summary">
                        <div class="summary-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            </svg>
                        </div>
                        <div class="summary-content">
                            <div class="summary-title">Выбранные коробки</div>
                            <div class="summary-count" id="box-count">0 коробок (0 шт.)</div>
                        </div>
                    </div>
                    
                    <!-- Список коробок -->
                    <div class="form-section">
                        <label class="section-label">Выберите коробки для распределения</label>
                        <div class="boxes-container">
                            {% for box, brand, total in all_boxes %}
                            <div class="box-item">
                                <label class="box-label">
                                    <input class="box-checkbox" type="checkbox" name="boxes" value="{{ box }}" data-total="{{ total }}">
                                    <span class="checkbox-custom"></span>
                                    <div class="box-info">
                                        <div class="box-name">Коробка {{ box }}</div>
                                        <div class="box-details">{{ brand }} <span class="box-quantity">{{ total }} шт.</span></div>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Выбор города -->
                    <div class="form-section">
                        <label for="city" class="section-label">Выберите город назначения</label>
                        <div class="select-wrapper">
                            <select class="custom-select" name="city" id="city" required>
                                <option value="">Выберите город</option>
                                {% for city in cities %}
                                <option value="{{ city }}">{{ city }}</option>
                                {% endfor %}
                            </select>
                            <div class="select-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <label class="section-label" for="party" style="margin-top: 5px"> Номер партии </label><input class="custom-select" type="text" name="party" id="party" value={{ max_party }}>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">
                        <span class="btn-text">Отмена</span>
                    </button>
                    <button type="submit" class="btn-save">
                        <span class="btn-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                        </span>
                        <span class="btn-text">Сохранить</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript для подсчёта количества и улучшений интерфейса -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Подсчет выбранных коробок
        const checkboxes = document.querySelectorAll('.box-checkbox');
        const counterDisplay = document.getElementById('box-count');
        
        function updateCounter() {
            let selectedCount = 0;
            let totalItems = 0;
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedCount++;
                    totalItems += parseInt(cb.dataset.total || '0', 10);
                }
            });
            
            counterDisplay.textContent = `${selectedCount} коробок (${totalItems} шт.)`;
            
            // Анимация счетчика
            counterDisplay.classList.add('updated');
            setTimeout(() => {
                counterDisplay.classList.remove('updated');
            }, 300);
        }
        
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateCounter);
        });
        
        // Поиск в таблице
        const searchInput = document.getElementById('searchInput');
        
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('.data-table tbody tr:not(.empty-row)');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Сортировка таблицы
        const sortableHeaders = document.querySelectorAll('.sortable');
        
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortBy = this.dataset.sort;
                const isAscending = !this.classList.contains('sort-asc');
                
                // Сбросить сортировку для всех заголовков
                sortableHeaders.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                // Установить новую сортировку
                this.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
                
                // Сортировка строк
                const tableBody = document.querySelector('.data-table tbody');
                const rows = Array.from(tableBody.querySelectorAll('tr:not(.empty-row)'));
                
                rows.sort((a, b) => {
                    let aValue, bValue;
                    
                    if (sortBy === 'brand') {
                        aValue = a.querySelector('.brand-cell').textContent;
                        bValue = b.querySelector('.brand-cell').textContent;
                    } else if (sortBy === 'model') {
                        aValue = a.querySelector('.model-cell').textContent;
                        bValue = b.querySelector('.model-cell').textContent;
                    } else if (sortBy === 'box') {
                        aValue = a.querySelector('.box-cell').textContent;
                        bValue = b.querySelector('.box-cell').textContent;
                    } else if (sortBy === 'quantity') {
                        aValue = parseInt(a.querySelector('.quantity-cell').textContent);
                        bValue = parseInt(b.querySelector('.quantity-cell').textContent);
                    }
                    
                    if (isAscending) {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });
                
                // Перестроить таблицу
                rows.forEach(row => {
                    tableBody.appendChild(row);
                });
            });
        });
    });
</script>
{% endblock content %}